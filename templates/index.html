<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>AI Product Assistant</title>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css')}}"/>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
	</head>
	
	
	<body>
		<div class="chat-container">
			<div class="chat-wrapper">
				<header class="chat-header">
					<div class="bot-avatar">
						<div class="avatar-circle">
							<i class="fas fa-robot"></i>
						</div>
						<div class="status-indicator"></div>
					</div>
					<div class="bot-info">
						<h1 class="bot-name">AI Product Assistant</h1>
						<p class="bot-status">Ready to help you find products</p>
					</div>
					<div class="header-actions">
						<button class="action-btn" title="Settings">
							<i class="fas fa-cog"></i>
						</button>
					</div>
				</header>

				<main class="chat-messages" id="messageContainer">
					<div class="welcome-message">
						<div class="welcome-icon">
							<i class="fas fa-sparkles"></i>
						</div>
						<h2>Welcome to your AI Shopping Assistant</h2>
						<p>Ask me anything about products, get recommendations, or find exactly what you're looking for!</p>
						<div class="quick-actions">
							<button class="quick-btn" onclick="sendQuickMessage('Show me trending products')">
								<i class="fas fa-fire"></i>
								Trending Products
							</button>
							<button class="quick-btn" onclick="sendQuickMessage('I need recommendations')">
								<i class="fas fa-star"></i>
								Get Recommendations
							</button>
						</div>
					</div>
				</main>

				<footer class="chat-input-container">
					<form id="messageArea" class="message-form">
						<div class="input-wrapper">
							<input type="text" id="text" name="msg" placeholder="Type your message here..." autocomplete="off" class="message-input" required/>
							<button type="button" class="attachment-btn" title="Attach file">
								<i class="fas fa-paperclip"></i>
							</button>
						</div>
						<button type="submit" id="send" class="send-button">
							<i class="fas fa-paper-plane"></i>
						</button>
					</form>
					<div class="input-footer">
						<p>AI Assistant can make mistakes. Please verify important information.</p>
					</div>
				</footer>
			</div>
		</div>
		
		<script>
			function sendQuickMessage(message) {
				$("#text").val(message);
				$("#messageArea").submit();
			}

			function formatTime() {
				const now = new Date();
				return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
			}

			function hideWelcomeMessage() {
				$(".welcome-message").fadeOut(300);
			}

			function formatContent(content, isUser) {
				if (isUser) {
					return content;
				}
				
				// Configure marked options for better formatting
				marked.setOptions({
					breaks: true,
					gfm: true,
					sanitize: false
				});
				
				// Convert markdown to HTML
				let formatted = marked.parse(content);
				
				// Additional formatting for common patterns
				formatted = formatted
					// Format product names or items in quotes
					.replace(/\"([^\"]+)\"/g, '<span class="highlight-text">"$1"</span>')
					// Format price patterns
					.replace(/₹\s*(\d+(?:,\d+)*(?:\.\d+)?)/g, '<span class="price-tag">₹$1</span>')
					.replace(/\$\s*(\d+(?:,\d+)*(?:\.\d+)?)/g, '<span class="price-tag">$$$1</span>')
					// Format numbers with commas as product specs
					.replace(/(\d+(?:,\d+)+)/g, '<span class="spec-number">$1</span>')
					// Format ratings
					.replace(/(\d+(?:\.\d+)?)\s*(?:\/\s*5|\s*stars?|\s*rating)/gi, '<span class="rating">$1 <i class="fas fa-star"></i></span>')
					// Format percentages (discounts)
					.replace(/(\d+)%\s*(?:off|discount)/gi, '<span class="discount">$1% OFF</span>');
				
				return formatted;
			}

			function addMessage(content, isUser, time) {
				const messageClass = isUser ? 'user-message' : 'bot-message';
				const avatar = isUser ? 
					'<div class="message-avatar user-avatar"><i class="fas fa-user"></i></div>' : 
					'<div class="message-avatar bot-avatar"><i class="fas fa-robot"></i></div>';
				
				const formattedContent = formatContent(content, isUser);
				
				const messageHtml = `
					<div class="message ${messageClass}">
						${!isUser ? avatar : ''}
						<div class="message-content">
							<div class="message-text">${formattedContent}</div>
							<div class="message-time">${time}</div>
						</div>
						${isUser ? avatar : ''}
					</div>
				`;
				
				$("#messageContainer").append(messageHtml);
				$("#messageContainer").scrollTop($("#messageContainer")[0].scrollHeight);
			}

			$(document).ready(function() {
				$("#messageArea").on("submit", function(event) {
					event.preventDefault();
					
					const rawText = $("#text").val().trim();
					if (!rawText) return;
					
					const currentTime = formatTime();
					
					hideWelcomeMessage();
					addMessage(rawText, true, currentTime);
					
					$("#text").val("");
					$(".send-button").addClass('sending');

					$.ajax({
						data: { msg: rawText },
						type: "POST",
						url: "/get",
					}).done(function(data) {
						setTimeout(() => {
							addMessage(data, false, currentTime);
							$(".send-button").removeClass('sending');
						}, 500);
					}).fail(function() {
						setTimeout(() => {
							addMessage("Sorry, I'm having trouble connecting. Please try again.", false, currentTime);
							$(".send-button").removeClass('sending');
						}, 500);
					});
				});

				$("#text").on("input", function() {
					$(this).parent().toggleClass('has-text', $(this).val().length > 0);
				});
			});
		</script>
        
    </body>
</html>